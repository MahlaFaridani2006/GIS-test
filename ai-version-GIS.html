<!DOCTYPE html>
<html lang="fa">
<head>
  <meta charset="UTF-8" />
  <title>Ù…Ø³ÛŒØ±ÛŒØ§Ø¨ Leaflet + OSRM (Optimized Variables)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    body, html { margin: 0; padding: 0; height: 100%; }
    #map { height: 100%; width: 100%; }
    .locate-btn {
      position: absolute;
      top: 10px;
      left: 10px;
      background: white;
      border: 1px solid #ccc;
      border-radius: 10px;
      padding: 8px 12px;
      cursor: pointer;
      font-family: sans-serif;
      z-index: 1000;
      transition: 0.2s;
    }
    .locate-btn:hover { background: #f5f5f5; transform: scale(1.05); }
  </style>
</head>
<body>
  <div id="map"></div>
  <button id="locate" class="locate-btn">ğŸ“ Ù…ÙˆÙ‚Ø¹ÛŒØª Ù…Ù†</button>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.min.js"></script>

  <script>
    // âœ… ÙÙ‚Ø· Ù…ØªØºÛŒØ±Ù‡Ø§ÛŒ Ø³Ø±Ø§Ø³Ø±ÛŒ Ø¯Ø§Ø®Ù„ ÛŒÚ© Ø¢Ø¨Ø¬Ú©Øª
    const state = {
      map: null,
      userMarker: null,
      destinationMarker: null,
      route: null,
      defaultCoords: [35.6892, 51.3890],
      defaultZoom: 13
    };

    // ğŸ—ºï¸ Ù…Ù‚Ø¯Ø§Ø±Ø¯Ù‡ÛŒ Ø§ÙˆÙ„ÛŒÙ‡ Ù†Ù‚Ø´Ù‡
    state.map = L.map('map').setView(state.defaultCoords, state.defaultZoom);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: 'Â© OpenStreetMap'
    }).addTo(state.map);

    // ğŸ“ Ú¯Ø±ÙØªÙ† Ù…ÙˆÙ‚Ø¹ÛŒØª ÙØ¹Ù„ÛŒ Ú©Ø§Ø±Ø¨Ø±
    function locateUser() {
      if (!navigator.geolocation) {
        alert("Ù…Ø±ÙˆØ±Ú¯Ø± Ø´Ù…Ø§ Ø§Ø² Ù…ÙˆÙ‚Ø¹ÛŒØªâ€ŒÛŒØ§Ø¨ÛŒ Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ù†Ù…ÛŒâ€ŒÚ©Ù†Ø¯!");
        return;
      }

      navigator.geolocation.getCurrentPosition(
        (pos) => {
          const coords = [pos.coords.latitude, pos.coords.longitude];
          if (!state.userMarker) {
            state.userMarker = L.marker(coords, { title: "Ù…Ø¨Ø¯Ø§ (Ø´Ù…Ø§)" }).addTo(state.map);
          } else {
            state.userMarker.setLatLng(coords);
          }
          state.map.setView(coords, 15);
        },
        (err) => {
          alert("Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ù…ÙˆÙ‚Ø¹ÛŒØª!");
          console.error(err);
        },
        { enableHighAccuracy: true }
      );
    }

    // ğŸ¯ ØªØ¹ÛŒÛŒÙ† Ù…Ù‚ØµØ¯ Ø¨Ø§ Ú©Ù„ÛŒÚ© Ø±ÙˆÛŒ Ù†Ù‚Ø´Ù‡
    function setDestination(e) {
      const dest = [e.latlng.lat, e.latlng.lng];
      if (!state.destinationMarker) {
        state.destinationMarker = L.marker(dest, { title: "Ù…Ù‚ØµØ¯" }).addTo(state.map);
      } else {
        state.destinationMarker.setLatLng(dest);
      }

      if (state.userMarker) {
        drawRoute(state.userMarker.getLatLng(), dest);
      } else {
        alert("Ø§ÙˆÙ„ Ø¯Ú©Ù…Ù‡ Ù…ÙˆÙ‚Ø¹ÛŒØª Ù…Ù† Ø±Ùˆ Ø¨Ø²Ù†!");
      }
    }

    // ğŸ›£ï¸ Ø±Ø³Ù… Ù…Ø³ÛŒØ± Ø¨ÛŒÙ† Ù…Ø¨Ø¯Ø§ Ùˆ Ù…Ù‚ØµØ¯
    function drawRoute(start, end) {
      if (state.route) state.map.removeControl(state.route);

      state.route = L.Routing.control({
        waypoints: [L.latLng(start), L.latLng(end)],
        lineOptions: { styles: [{ color: '#007bff', weight: 5 }] },
        createMarker: () => null,
        addWaypoints: false
      }).addTo(state.map);
    }

    // ğŸ–± Ø±ÙˆÛŒØ¯Ø§Ø¯Ù‡Ø§
    document.getElementById('locate').addEventListener('click', locateUser);
    state.map.on('click', setDestination);
  </script>
</body>
</html>
