<!DOCTYPE html>
<html lang="fa">
<head>
  <meta charset="UTF-8">
  <title>Ù…Ø³ÛŒØ±ÛŒØ§Ø¨ Ø³Ø§Ø¯Ù‡ Ùˆ Ø³Ø±ÛŒØ¹</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    body { margin:0; font-family:sans-serif; display:flex; flex-direction:column; height:100vh; }
    #controls { background:#f5f5f5; padding:8px; display:flex; flex-wrap:wrap; justify-content:center; gap:6px; border-bottom:1px solid #ddd; }
    input,button { padding:8px; border-radius:8px; border:1px solid #ccc; font-size:14px; }
    button { cursor:pointer; }
    #map { flex:1; }
    @media(max-width:768px){ #controls{flex-direction:column;} input,button{width:100%;font-size:16px;} }
  </style>
</head>
<body>
  <div id="controls">
    <input id="start" placeholder="Ù…Ø¨Ø¯Ø§ (Ø±ÙˆÛŒ Ù†Ù‚Ø´Ù‡ ÛŒØ§ Ø¯Ø³ØªÛŒ)">
    <button id="myLoc">ğŸ“ Ù…ÙˆÙ‚Ø¹ÛŒØª Ù…Ù†</button>
    <input id="end" placeholder="Ù…Ù‚ØµØ¯ (Ø±ÙˆÛŒ Ù†Ù‚Ø´Ù‡ ÛŒØ§ Ø¯Ø³ØªÛŒ)">
    <button id="route">ğŸš— Ù…Ø³ÛŒØ±ÛŒØ§Ø¨ÛŒ</button>
    <button id="reset" style="background:#ff5c5c;color:white;">ğŸ”„ Ø±ÛŒØ³Øª</button>
  </div>
  <div id="map"></div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.js"></script>
  <script>
    const app = {
      map:null, route:null, watchId:null,
      markers:{start:null,end:null,user:null},
      coords:{start:null,end:null},
      init(){
        this.map=L.map('map').setView([35.6892,51.389],13);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(this.map);
        this.map.on('click',e=>this.handleClick(e));
        this.bindUI();
      },
      bindUI(){
        id('myLoc').onclick=()=>this.locateUser();
        id('route').onclick=()=>this.makeRoute();
        id('reset').onclick=()=>this.reset();
      },
      handleClick(e){
        const {lat,lng}=e.latlng;
        if(!this.coords.start){
          this.setPoint('start',lat,lng,'Ù…Ø¨Ø¯Ø§');
          id('start').value=`${lat.toFixed(5)},${lng.toFixed(5)}`;
        }else if(!this.coords.end){
          this.setPoint('end',lat,lng,'Ù…Ù‚ØµØ¯');
          id('end').value=`${lat.toFixed(5)},${lng.toFixed(5)}`;
        }
      },
      setPoint(type,lat,lng,label){
        if(this.markers[type]) this.map.removeLayer(this.markers[type]);
        this.markers[type]=L.marker([lat,lng]).addTo(this.map).bindPopup(label).openPopup();
        this.coords[type]=[lat,lng];
      },
      async geocode(q){
        const res=await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${q}`);
        const d=await res.json(); return d[0]?[+d[0].lat,+d[0].lon]:null;
      },
      locateUser(){
        if(!navigator.geolocation) return alert('GPS Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ù†Ù…ÛŒâ€ŒØ´ÙˆØ¯');
        navigator.geolocation.getCurrentPosition(pos=>{
          const {latitude,longitude}=pos.coords;
          this.setPoint('start',latitude,longitude,'Ø´Ù…Ø§ Ø§ÛŒÙ†Ø¬Ø§ Ù‡Ø³ØªÛŒØ¯');
          this.map.setView([latitude,longitude],15);
          id('start').value=`${latitude.toFixed(5)},${longitude.toFixed(5)}`;
        });
      },
      async makeRoute(){
        let s=this.coords.start||await this.geocode(id('start').value.trim());
        let e=this.coords.end||await this.geocode(id('end').value.trim());
        if(!s||!e) return alert('Ù…Ø¨Ø¯Ø§ Ùˆ Ù…Ù‚ØµØ¯ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯');
        this.coords={start:s,end:e};
        if(this.route) this.map.removeControl(this.route);
        this.route=L.Routing.control({
          waypoints:[L.latLng(...s),L.latLng(...e)], routeWhileDragging:false
        }).on('routesfound',ev=>{
          const t=Math.round(ev.routes[0].summary.totalTime/60);
          alert(`â± Ø²Ù…Ø§Ù† ØªÙ‚Ø±ÛŒØ¨ÛŒ: ${t} Ø¯Ù‚ÛŒÙ‚Ù‡`);
        }).addTo(this.map);
        this.trackUser();
      },
      trackUser(){
        if(this.watchId) navigator.geolocation.clearWatch(this.watchId);
        this.watchId=navigator.geolocation.watchPosition(pos=>{
          const {latitude,longitude}=pos.coords;
          if(this.markers.user) this.map.removeLayer(this.markers.user);
          this.markers.user=L.circleMarker([latitude,longitude],{
            radius:6,color:'blue',fillColor:'blue',fillOpacity:0.8
          }).addTo(this.map);
          const dist=this.map.distance([latitude,longitude],this.coords.end);
          if(dist<50){ alert('ğŸ‰ Ø¨Ù‡ Ù…Ù‚ØµØ¯ Ø±Ø³ÛŒØ¯ÛŒØ¯!'); navigator.geolocation.clearWatch(this.watchId); }
        },()=>{}, {enableHighAccuracy:true});
      },
      reset(){
        if(this.route) this.map.removeControl(this.route);
        Object.values(this.markers).forEach(m=>m&&this.map.removeLayer(m));
        if(this.watchId) navigator.geolocation.clearWatch(this.watchId);
        this.markers={start:null,end:null,user:null};
        this.coords={start:null,end:null};
        id('start').value=id('end').value='';
        this.map.setView([35.6892,51.389],13);
      }
    };
    const id=x=>document.getElementById(x);
    app.init();
  </script>
</body>
</html>
