<!DOCTYPE html>
<html lang="fa">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Ù…Ø³ÛŒØ±â€ŒÛŒØ§Ø¨ Ù…Ù†</title>

<link
  rel="stylesheet"
  href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
  * {
    box-sizing: border-box;
    font-family: "Vazirmatn", sans-serif;
  }
  body {
    margin: 0;
    background: #f6f7fb;
    display: flex;
    flex-direction: column;
    height: 100vh;
  }
  #map {
    flex: 1;
    width: 100%;
  }
  .panel {
    background: white;
    padding: 12px;
    box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
    border-radius: 16px 16px 0 0;
    display: flex;
    flex-direction: column;
    gap: 8px;
  }
  input, button {
    padding: 10px;
    font-size: 16px;
    border-radius: 10px;
    border: 1px solid #ccc;
    width: 100%;
  }
  button {
    background-color: #4a7ef5;
    color: white;
    border: none;
    cursor: pointer;
  }
  button.cancel {
    background-color: #f54242;
  }
  button:active {
    opacity: 0.8;
  }
  @media (min-width: 768px) {
    .panel {
      flex-direction: row;
      align-items: center;
      justify-content: space-between;
      padding: 16px 24px;
    }
    input {
      width: 30%;
    }
    button {
      width: auto;
    }
  }
</style>
</head>
<body>

<div id="map"></div>

<div class="panel">
  <input type="text" id="start" placeholder="ğŸ“ Ù…Ø¨Ø¯Ø§ (Ø§Ø®ØªÛŒØ§Ø±ÛŒ)" />
  <input type="text" id="end" placeholder="ğŸ¯ Ù…Ù‚ØµØ¯" />
  <button id="routeBtn">Ø´Ø±ÙˆØ¹ Ù…Ø³ÛŒØ±</button>
  <button class="cancel" id="cancelBtn">Ø§Ù†ØµØ±Ø§Ù</button>
</div>

<script>
const App = {
  map: null,
  userMarker: null,
  destMarker: null,
  routeLine: null,
  watchId: null,
  destination: null,

  init() {
    this.map = L.map("map").setView([35.6892, 51.3890], 13);

    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      maxZoom: 19,
    }).addTo(this.map);

    document.getElementById("routeBtn").onclick = () => this.startRoute();
    document.getElementById("cancelBtn").onclick = () => this.resetAll();

    this.locateUser();
  },

  locateUser() {
    if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition(
        (pos) => {
          const latlng = [pos.coords.latitude, pos.coords.longitude];
          this.map.setView(latlng, 14);
          this.userMarker = L.marker(latlng).addTo(this.map)
            .bindPopup("ğŸ“ Ù…ÙˆÙ‚Ø¹ÛŒØª Ø´Ù…Ø§").openPopup();
        },
        () => alert("Ø§Ø¬Ø§Ø²Ù‡ Ø¯Ø³ØªØ±Ø³ÛŒ Ø¨Ù‡ Ù…ÙˆÙ‚Ø¹ÛŒØª Ø¯Ø§Ø¯Ù‡ Ù†Ø´Ø¯!")
      );
    } else alert("Ù…Ø±ÙˆØ±Ú¯Ø± Ø´Ù…Ø§ Ù…ÙˆÙ‚Ø¹ÛŒØª Ø¬ØºØ±Ø§ÙÛŒØ§ÛŒÛŒ Ø±Ø§ Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ù†Ù…ÛŒâ€ŒÚ©Ù†Ø¯!");
  },

  startRoute() {
    const endInput = document.getElementById("end").value.trim();
    if (!endInput) return alert("Ù„Ø·ÙØ§Ù‹ Ù…Ù‚ØµØ¯ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯!");

    // Ù…ÙˆÙ‚Ø¹ÛŒØª ÙØ¹Ù„ÛŒ Ú©Ø§Ø±Ø¨Ø± Ø±Ø§ Ø¯Ø±ÛŒØ§ÙØª Ú©Ù†ÛŒÙ…
    navigator.geolocation.getCurrentPosition((pos) => {
      const startLatLng = [pos.coords.latitude, pos.coords.longitude];
      this.getCoordsFromName(endInput).then((destLatLng) => {
        this.destination = destLatLng;
        this.showRoute(startLatLng, destLatLng);
        this.trackMovement(destLatLng);
      });
    });
  },

  async getCoordsFromName(place) {
    const res = await fetch(
      `https://nominatim.openstreetmap.org/search?format=json&q=${place}`
    );
    const data = await res.json();
    if (data.length === 0) {
      alert("Ù…Ú©Ø§Ù† ÛŒØ§ÙØª Ù†Ø´Ø¯!");
      throw new Error("Ù…Ú©Ø§Ù† ÛŒØ§ÙØª Ù†Ø´Ø¯");
    }
    return [data[0].lat, data[0].lon];
  },

  showRoute(start, end) {
    if (this.destMarker) this.map.removeLayer(this.destMarker);
    this.destMarker = L.marker(end).addTo(this.map).bindPopup("ğŸ¯ Ù…Ù‚ØµØ¯");

    if (this.routeLine) this.map.removeLayer(this.routeLine);
    this.routeLine = L.polyline([start, end], { color: "blue" }).addTo(this.map);

    const distance = this.map.distance(start, end);
    const timeMin = (distance / 80).toFixed(1); // ÙØ±Ø¶ÛŒ: Ø³Ø±Ø¹Øª 80 Ù…ØªØ± Ø¨Ø± Ø¯Ù‚ÛŒÙ‚Ù‡
    alert(`ÙØ§ØµÙ„Ù‡ ØªÙ‚Ø±ÛŒØ¨ÛŒ ${(distance / 1000).toFixed(2)} Ú©ÛŒÙ„ÙˆÙ…ØªØ± Ùˆ Ø­Ø¯ÙˆØ¯ ${timeMin} Ø¯Ù‚ÛŒÙ‚Ù‡ Ø±Ø§Ù‡ Ø§Ø³Øª.`);
  },

  trackMovement(dest) {
    if (this.watchId) navigator.geolocation.clearWatch(this.watchId);

    this.watchId = navigator.geolocation.watchPosition((pos) => {
      const userLatLng = [pos.coords.latitude, pos.coords.longitude];

      if (this.userMarker) this.userMarker.setLatLng(userLatLng);
      else this.userMarker = L.marker(userLatLng).addTo(this.map);

      const distance = this.map.distance(userLatLng, dest);
      if (distance < 30) {
        alert("ğŸ‰ Ø¨Ù‡ Ù…Ù‚ØµØ¯ Ø±Ø³ÛŒØ¯ÛŒØ¯! Ø®ÙˆØ´ Ø¢Ù…Ø¯ÛŒØ¯!");
        navigator.geolocation.clearWatch(this.watchId);
      }
    });
  },

  resetAll() {
    if (this.routeLine) this.map.removeLayer(this.routeLine);
    if (this.destMarker) this.map.removeLayer(this.destMarker);
    this.destination = null;
    if (this.watchId) navigator.geolocation.clearWatch(this.watchId);
    document.getElementById("end").value = "";
    this.locateUser();
    alert("ğŸ”„ Ù…Ø³ÛŒØ± Ù„ØºÙˆ Ø´Ø¯ Ùˆ Ø¨Ù‡ Ø­Ø§Ù„Øª Ø§ÙˆÙ„ÛŒÙ‡ Ø¨Ø§Ø²Ú¯Ø´Øª.");
  }
};

App.init();
</script>
</body>
</html>
